<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Instructor SENA</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css}">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #FFFFFF;
      /* White background based on content area in image */
      color: #161616;
      /* Dark green text for general content, matching SENA logo text */
      display: flex;
    }

    .sidebar {
      width: 250px;
      background: #006B2D;
      /* Dark green from SENA header/footer in image */
      padding: 20px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-shadow: 2px 0 10px rgba(0, 107, 45, 0.2);
      /* Subtle green shadow */
    }

    .sidebar a {
      color: #FFFFFF;
      /* White text for sidebar links */
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .sidebar a:hover {
      background: #008D4D;
      /* Slightly lighter green on hover for sidebar */
      color: #FFFFFF;
    }

    .content {
      margin-left: 270px;
      padding: 30px;
      flex-grow: 1;
      background-color: #FFFFFF;
      /* White content background matching image */
    }

    .dashboard-header {
      text-align: center;
      margin-bottom: 30px;
      color: #006B2D;
      /* Dark green header text */
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .card {
      background: #F0FFF0;
      /* Very light green card background, like subtle white */
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0, 107, 45, 0.1);
      /* Subtle green shadow */
      transition: transform 0.3s;
      cursor: pointer;
      color: #0f0f0f;
      /* Dark green card text */
      border: 1px solid #f3f3f3;
      /* Light green border */
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 107, 45, 0.15);
      /* More pronounced green shadow on hover */
      border: 1px solid #171817;
      /* Dark green border on hover */
    }

    .card i {
      font-size: 40px;
      color: #1c1d1c;
      /* Bright SENA green for icons, from "¬°Comienza ahora!" button */
      margin-bottom: 15px;
    }

    .section {
      display: none;
      margin-top: 20px;
      background: #FFFFFF;
      /* White section background */
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 107, 45, 0.1);
      /* Subtle green shadow */
      color: #111111;
      /* Dark green section text */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ebf3eb;
      /* Light green border */
      padding: 10px;
      text-align: center;
      color: #171818;
      /* Dark green table cell text */
    }

    th {
      background: #ffffff;
      /* Bright SENA green for table headers */
      color: #171817;
      /* Dark green text on green header */
    }

    button {
      background: #eff5ef;
      /* Bright SENA green for buttons */
      color: #000000;
      /* Dark green text for buttons */
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
      transition: all 0.3s;
    }

    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 10px rgba(211, 216, 211, 0.5);
      /* Green glow on hover */
    }

    .btn-verde {
      background: #24ad02;
      /* Explicit green button */
      color: #f5f5f5;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: #F0FFF0;
      /* Very light green input background */
      color: #000000;
      /* Dark green input text */
      border: 1px solid #8d918d;
      /* Light green border */
      border-radius: 5px;
    }

    .file-upload {
      border: 2px dashed #006B2D;
      /* Dark green dashed border */
      padding: 20px;
      text-align: center;
      border-radius: 5px;
      margin: 15px 0;
      color: #006B2D;
      /* Dark green file upload text */
    }

    .doc-list {
      background: #F0FFF0;
      /* Very light green doc list background */
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      color: #006B2D;
      /* Dark green doc list text */
      border: 1px solid #98FB98;
      /* Light green border */
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge-pendiente {
      background: #ffd902;
      /* Light green for pending, a distinct green */
      color: #151616;
      /* Dark green text on light green badge */
    }

    .badge-aprobado {
      background: #20860d;
      /* Bright SENA green for approved */
      color: #f3f7f3;
      /* Dark green text on bright green badge */
    }

    .badge-rechazado {
      background: #d63912;
      /* Orange for rejected - a contrasting but not clashing color for status */
      color: white;
    }

    /* Specific styles for inner elements to ensure consistency */
    #cronograma>div>div {
      background: #F0FFF0 !important;
      /* Light green background for inner cronograma divs */
      color: #191b1a !important;
      border: 1px solid #e9f5e9 !important;
    }

    #aulas form {
      background: #F0FFF0 !important;
      /* Light green background for Aula form */
      color: #191a19 !important;
      border: 1px solid #141614 !important;
    }

    /* Chat bubbles for instructor */
    #mensajes-grupo {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      overflow-y: auto;
      background: #fff;
    }

    .message-row {
      display: flex;
      margin: 4px 0;
    }

    .message-row.own {
      justify-content: flex-end;
    }

    .message-row.left {
      justify-content: flex-start;
    }

    .chat-bubble {
      max-width: 72%;
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      word-wrap: break-word;
      line-height: 1.2em;
    }

    .chat-bubble.own {
      background: #28a745; /* verde brillante para el instructor (t√∫) */
      color: #ffffff;
      border-top-right-radius: 6px;
      box-shadow: 0 2px 6px rgba(40,167,69,0.2);
    }

    .chat-bubble.aprendiz {
      background: #007bff; /* azul llamativo para aprendices */
      color: #ffffff;
      border-top-left-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,123,255,0.18);
    }

    .chat-bubble.other {
      background: #ff8c00; /* naranja brillante para otros instructores */
      color: #ffffff;
      box-shadow: 0 2px 6px rgba(255,140,0,0.18);
    }

    #mensajes>div>div:first-child {
      /* Message list (left pane) */
      background: #fd0b0b !important;
      /* Light green background */
      color: #eaf0ea !important;
      border-radius: 10px;
      border: 1px solid #98FB98 !important;
    }

    #mensajes>div>div:nth-child(2) {
      /* Chat window (right pane) */
      background: #4b9162 !important;
      /* White background */
      color: #006B2D !important;
      border-radius: 10px;
      border: 1px solid #98FB98 !important;
    bubble.innerHTML = `<strong>${emoji} ${nombre || ''}</strong><br>`;
    const contentDiv = document.createElement('div');
    contentDiv.style.marginTop = '6px';
    if (m && m.fileUrl) {
      const a = document.createElement('a');
      a.href = m.fileUrl;
      a.textContent = m.fileName || m.fileUrl;
      a.target = '_blank';
      a.style.color = '#fff';
      a.style.textDecoration = 'underline';
      contentDiv.appendChild(a);
      if (m.mensaje) {
        const span = document.createElement('div');
        span.style.marginTop = '6px';
        span.textContent = mensajeEsc;
        contentDiv.appendChild(span);
      }
    } else {
      contentDiv.textContent = mensajeEsc;
    }
    bubble.appendChild(contentDiv);

    // Determinar tipo: propio (instructor), aprendiz, u otros
    const isOwn = (m && (m.idEmisor !== undefined ? String(m.idEmisor) === String(idUsuario) : false));

    td {
      padding: 8px;
      text-align: center;
      vertical-align: top;
      border: 1px solid #ccc;
      font-size: 0.9em;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <a href="#" onclick="showSection('cronograma')"><i class="fas fa-calendar-alt"></i> Mi Cronograma</a>
    <a href="#" onclick="showSection('certificados')"><i class="fas fa-file-alt"></i> Certificados</a>
    <a href="#" onclick="showSection('equipos')"><i class="fas fa-laptop"></i> Mis Equipos</a>
    <a href="#" onclick="showSection('vehiculos')"><i class="fas fa-car"></i> Veh√≠culos</a>
    <a href="#" onclick="showSection('aulas')"><i class="fas fa-door-open"></i> Gesti√≥n de Aulas</a>
    <a href="#" onclick="showSection('incapacidades')"><i class="fas fa-file-medical"></i> Incapacidades</a>
    <a href="#" onclick="showSection('trabajos')"><i class="fas fa-tasks"></i> Revisi√≥n Trabajos</a>
    <a href="#" onclick="showSection('mensajes')"><i class="fas fa-comments"></i> Mensajes</a>
    <a href="#" onclick="showSection('correos-masivos')"><i class="fas fa-envelope"></i> Enviar Correos</a>
    <!-- <a href="#" onclick="showSection('subir-programacion')"><i class="fas fa-upload"></i> Subir Programaci√≥n</a> -->
    <a th:href="@{/login}"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
  </div>

  <div class="content">
    <div class="dashboard-header">
      <h1>Panel del Instructor SENA</h1>
      <p>Bienvenido, <span th:text="${usuario}">Usuario</span></p>
    </div>

    <section class="cards">
      <div class="card" onclick="showSection('cronograma')">
        <i class="fas fa-calendar-alt"></i>
        <h3>Mi Cronograma</h3>
        <p>Horarios y actividades</p>
      </div>
      <div class="card" onclick="showSection('vehiculos')">
        <i class="fas fa-car"></i>
        <h3>Veh√≠culos</h3>
        <p>Registra tus veh√≠culos</p>
      </div>
      <div class="card" onclick="showSection('aulas')">
        <i class="fas fa-door-open"></i>
        <h3>Gesti√≥n de Aulas</h3>
        <p>Solicitar apertura/cierre</p>
      </div>
      <div class="card" onclick="showSection('trabajos')">
        <i class="fas fa-tasks"></i>
        <h3>Trabajos</h3>
        <p>Revisar entregas</p>
      </div>
    </section>

    <section id="cronograma" class="section">
      <h2><i class="fas fa-calendar-alt"></i> Mi Cronograma</h2>
      <button onclick="abrirCalendarioGeneral()" style="
  margin-top: 10px;
  background: #006B2D;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
">
        üìÖ Ver Calendario Trimestral
      </button>

      <!-- Selector de instrucor -->
      <div style="margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
        <label for="selector-instructor" style="font-weight: bold; margin-right: 10px;">Ver cronograma de:</label>
        <select id="selector-instructor" style="padding: 8px; border: 1px solid #006B2D; border-radius: 4px;">
          <option value="">-- Mi Cronograma --</option>
        </select>
      </div>

      <!-- Aqu√≠ se cargar√° la tabla de programaci√≥n del instructor -->
      <div id="tabla-programacion" style="margin-top:20px;">
        <p style="color: #666;">Cargando programaci√≥n...</p>
      </div>

      <!-- Opcional: buscador de otro instructor -->
      <!--<div style="margin-top:20px;">
    <label for="buscar-instructor">Buscar otro instructor:</label>
    <input type="text" id="buscar-instructor" placeholder="Nombre del instructor">
    <button onclick="buscarOtroInstructor()" style="padding: 5px 10px; background: #006B2D; color: white; border: none; border-radius: 3px;">
      Buscar
    </button>
  </div>-->
    </section>

    <!-- ‚úÖ Modal flotante para mostrar d√≠as -->
    <div id="modal-dias" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  display: none; /* ‚Üê solo este */
  justify-content: center;
  align-items: center;
">

      <div id="contenido-modal-dias" style="
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 900px;
    width: 95%;
    max-height: 90%;
    overflow-y: auto;
    position: relative;
  ">
        <button onclick="cerrarModalDias()" style="
      position: absolute;
      top: 10px; right: 10px;
      background: #ccc;
      border: none;
      border-radius: 50%;
      width: 30px; height: 30px;
      font-weight: bold;
      cursor: pointer;
    ">√ó</button>

        <div id="info-ficha-curso" style="margin-bottom: 10px;"></div>

        <div style="text-align: right; margin-bottom: 10px;">
          <button onclick="imprimirCalendario()" style="
        background: #006B2D;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      ">üñ®Ô∏è Imprimir</button>
        </div>

        <div id="calendario-trimestre"></div>
      </div>
    </div>
    <div id="modal-calendario-general" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">

      <div id="contenido-modal-calendario" style="
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 900px;
    width: 95%;
    max-height: 90%;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  ">
        <button onclick="cerrarCalendarioGeneral()" style="
      position: absolute;
      top: 10px; right: 10px;
      background: #ccc;
      border: none;
      border-radius: 50%;
      width: 30px; height: 30px;
      font-weight: bold;
      cursor: pointer;
    ">√ó</button>

        <h3 style="margin-top: 0; color: #006B2D;">Calendario Trimestral del Instructor</h3>

        <div style="text-align: right; margin-bottom: 10px;">
          <button onclick="exportarCalendarioGeneral()" style="
        background: #006B2D;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      ">üñ®Ô∏è Exportar como PDF</button>
        </div>

        <div id="contenido-calendario-general"></div>
      </div>
    </div>

    <section id="certificados" class="section">
    <h2><i class="fas fa-file-alt"></i> Certificados Laborales</h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        
        <div class="card" onclick="descargarCertificado('laboral')">
            <i class="fas fa-briefcase"></i>
            <h3>Certificado Laboral</h3>
            <p>Descargar en PDF</p>
        </div>

        <div class="card" onclick="descargarCertificado('nomina')">
            <i class="fas fa-file-invoice-dollar"></i>
            <h3>Desprendible de N√≥mina</h3>
            <p>Descargar √∫ltimo pago</p>
        </div>

        <div class="card" onclick="descargarCertificado('vinculacion')">
            <i class="fas fa-file-contract"></i>
            <h3>Constancia de Vinculaci√≥n</h3>
            <p>Descargar en PDF</p>
        </div>

    </div>
</section>

    <section id="equipos" class="section">
      <h2><i class="fas fa-laptop"></i> Registro de Equipos</h2>
      <a th:href="@{/equipos}">
        <button type="button"><i class="fas fa-plus-circle"></i> Registrar Nuevo Equipo</button>
      </a>

      <h2><i class="fas fa-table"></i> Lista de Equipos Registrados</h2>
      <div th:if="${mensaje}"
        style="background-color:#d4edda; color:#155724; padding:10px; border-radius:5px; margin-bottom:10px;">
        <i class="fas fa-check-circle"></i> <span th:text="${mensaje}"></span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Marca/Modelo</th>
            <th>Serie</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="equipo : ${equipos}" th:if="${equipo.estado == 1}">
            <td th:text="${equipo.tipoEquipo}"></td>
            <td th:text="${equipo.marcaModelo}"></td>
            <td th:text="${equipo.numeroSerie}"></td>
            <td th:text="${equipo.estado == 1 ? 'Activo' : 'Inactivo'}"></td>
            <td>
              <button type="button"
                style="background:#007bff; color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer; margin-right:5px;"
                th:attr="onclick='editarEquipo(' + ${equipo.idEquipo} + ')'">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button type="button"
                style="background:#FF8C00; color:white; border:none; border-radius:5px; padding:5px 10px; cursor:pointer;"
                th:attr="onclick='eliminarEquipoAjax(' + ${equipo.idEquipo} + ')'">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </td>
            <script>
              function editarEquipo(idEquipo) {
                // Redirige a la p√°gina de edici√≥n del equipo
                window.location.href = '/equipos/editar/' + idEquipo;
              }
              function eliminarEquipoAjax(idEquipo) {
                if (!confirm('¬øSeguro que deseas eliminar este equipo?')) return;
                fetch(`/equipos/desactivar/${idEquipo}`, { method: 'POST' })
                  .then(res => {
                    if (!res.ok) throw new Error('Error al eliminar equipo');
                    // Eliminar la fila de la tabla
                    const fila = document.querySelector(`button[onclick*='${idEquipo}']`).closest('tr');
                    if (fila) fila.remove();
                    // Mostrar mensaje de √©xito
                    mostrarMensaje('El equipo se ha eliminado correctamente.');
                  })
                  .catch(() => mostrarMensaje('No se pudo eliminar el equipo.'));
              }
              function mostrarMensaje(msg) {
                let div = document.getElementById('mensajeExito');
                if (!div) {
                  div = document.createElement('div');
                  div.id = 'mensajeExito';
                  div.style.backgroundColor = '#d4edda';
                  div.style.color = '#155724';
                  div.style.padding = '10px';
                  div.style.borderRadius = '5px';
                  div.style.marginBottom = '10px';
                  div.innerHTML = `<i class='fas fa-check-circle'></i> <span></span>`;
                  const tabla = document.querySelector('#equipos table');
                  tabla.parentNode.insertBefore(div, tabla);
                }
                div.querySelector('span').textContent = msg;
                div.style.display = 'block';
                setTimeout(() => { div.style.display = 'none'; }, 2500);
              }
            </script>
          </tr>
          <tr th:if="${equipos == null or #lists.isEmpty(equipos)}">
            <td colspan="5" style="text-align:center; color:#888;">No hay equipos registrados.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section id="aulas" class="section">
      <h2><i class="fas fa-door-open"></i> Gesti√≥n de Aulas</h2>

      <form style="background: #F0FFF0; padding: 20px; border-radius: 10px; border: 1px solid #98FB98;">
        <h3>Solicitud de Aula</h3>
        <label>Aula:</label>
        <select>
          <option>Aula 101</option>
          <option>Aula 203</option>
          <option>Laboratorio 3</option>
          <option>Laboratorio 4</option>
        </select>

        <label>Tipo de Solicitud:</label>
        <select>
          <option>Apertura</option>
          <option>Cierre</option>
          <option>Reporte de mantenimiento</option>
        </select>

        <label>Fecha/Hora:</label>
        <input type="datetime-local">

        <label>Descripci√≥n del estado:</label>
        <textarea rows="3" placeholder="Ej: Aula limpia, pero falta marcador..."></textarea>

        <button type="submit"><i class="fas fa-paper-plane"></i> Enviar Solicitud</button>
      </form>

      <h3 style="margin-top: 30px;">Historial Reciente</h3>
      <table>
        <tr>
          <th>Fecha</th>
          <th>Aula</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Comentarios</th>
        </tr>
        <tr>
          <td>15/05/2024</td>
          <td>203</td>
          <td>Cierre</td>
          <td><span class="badge badge-aprobado">Aprobado</span></td>
          <td>Aula en buen estado</td>
        </tr>
        <tr>
          <td>10/05/2024</td>
          <td>Lab 4</td>
          <td>Reporte</td>
          <td><span class="badge badge-pendiente">Pendiente</span></td>
          <td>Proyector no funciona</td>
        </tr>
      </table>
    </section>

    <section id="incapacidades" class="section">
      <h2><i class="fas fa-file-medical"></i> Revisi√≥n de Incapacidades</h2>

      <table>
        <tr>
          <th>Aprendiz</th>
          <th>Fecha</th>
          <th>Documento</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        <tr>
          <td>Mar√≠a Jim√©nez</td>
          <td>15/05/2024</td>
          <td><i class="fas fa-file-pdf"></i> Incapacidad.pdf</td>
          <td><span class="badge badge-pendiente">Pendiente</span></td>
          <td>
            <button class="btn-verde" onclick="aprobarIncapacidad(1)"><i class="fas fa-check"></i> Aprobar</button>
            <button onclick="rechazarIncapacidad(1)" style="background-color: #FF8C00; color: white;"><i
                class="fas fa-times"></i> Rechazar</button>
          </td>
        </tr>
        <tr>
          <td>Carlos Rodr√≠guez</td>
          <td>10/05/2024</td>
          <td><i class="fas fa-file-image"></i> Incapacidad.jpg</td>
          <td><span class="badge badge-aprobado">Aprobada</span></td>
          <td>-</td>
        </tr>
      </table>
    </section>

    <section id="trabajos" class="section">
      <h2><i class="fas fa-tasks"></i> Revisi√≥n de Trabajos</h2>

      <div style="margin-bottom: 20px;">
        <label>Filtrar por curso:</label>
        <select onchange="filtrarTrabajos(this.value)"
          style="width: 300px; display: inline-block; margin-left: 10px; background: #F0FFF0; color: #0c0c0c; border: 1px solid #98FB98;">
          <option value="todos">Todos los cursos</option>
          <option value="programacion">Programaci√≥n</option>
          <option value="basedatos">Base de Datos</option>
        </select>
      </div>

      <table>
        <tr>
          <th>Aprendiz</th>
          <th>Actividad</th>
          <th>Fecha Entrega</th>
          <th>Archivo</th>
          <th>Calificaci√≥n</th>
          <th>Feedback</th>
        </tr>
        <tr>
          <td>Mar√≠a Jim√©nez</td>
          <td>Proyecto BD</td>
          <td>15/05/2024</td>
          <td><i class="fas fa-file-code"></i> proyecto.zip</td>
          <td>
            <select style="width: 60px; background: #F0FFF0; color: #1a1b1b; border: 1px solid #0c0c0c;">
              <option>5.0</option>
              <option selected>4.8</option>
              <option>4.5</option>
            </select>
          </td>
          <td>
            <button onclick="mostrarFeedback(1)"><i class="fas fa-comment-dots"></i> Ver</button>
          </td>
        </tr>
        <tr>
          <td>Carlos Rodr√≠guez</td>
          <td>Taller SQL</td>
          <td>12/05/2024</td>
          <td><i class="fas fa-file-word"></i> taller.docx</td>
          <td>-</td>
          <td>
            <button onclick="mostrarFeedback(2)"><i class="fas fa-edit"></i> Calificar</button>
          </td>
        </tr>
      </table>
    </section>

    <section id="mensajes" class="section" style="display:none; height:500px;">
  <div style="width:30%">
    <ul id="fichas-chat"></ul>
  </div>

  <div style="width:70%; display:flex; flex-direction:column;">
    <h3 id="titulo-chat"></h3>
    <div id="mensajes-grupo" style="flex:1; overflow:auto;"></div>

    <form id="form-chat" style="display:flex; gap:8px; margin-top:8px; align-items:center;">
      <label style="cursor:pointer; font-size:20px; flex:0 0 auto; display:flex; align-items:center;">
        üìé
        <input type="file" id="archivo-mensaje" style="display:none;" onchange="uploadFileInstructor()">
      </label>
      <input id="mensaje" placeholder="Escribe un mensaje..." style="flex:1;">
      <button type="submit" style="flex:0 0 auto; padding:8px 16px;">Enviar</button>
    </form>
  </div>
</section>




    <section id="correos-masivos" class="section">
      <h2><i class="fas fa-envelope"></i> Enviar Correos Masivos a Aprendices</h2>

      <form id="formulario-correos"
        style="background: #F0FFF0; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">

        <div style="margin-bottom: 20px;">
          <label for="seleccionar-aprendices" style="display: block; font-weight: bold; margin-bottom: 10px;">
            <i class="fas fa-users"></i> Seleccionar Aprendices:
          </label>
          <div id="lista-aprendices" style="
                        border: 1px solid #ccc;
                        border-radius: 5px;
                        padding: 15px;
                        background: white;
                        max-height: 250px;
                        overflow-y: auto;
                        margin-bottom: 10px;
                    ">
            <p style="color: #999; text-align: center;">Cargando aprendices...</p>
          </div>

          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button type="button" onclick="seleccionarTodosAprendices()" class="btn-verde" style="flex: 1;">
              ‚úì Seleccionar Todos
            </button>
            <button type="button" onclick="deseleccionarTodosAprendices()" style="flex: 1;">
              ‚úó Deseleccionar Todos
            </button>
          </div>

          <p style="color: #666; font-size: 0.9em;">
            <strong id="contador-seleccionados">0</strong> aprendiz(es) seleccionado(s)
          </p>
        </div>

        <div style="margin-bottom: 20px;">
          <label for="asunto-correo" style="display: block; font-weight: bold; margin-bottom: 8px;">
            <i class="fas fa-heading"></i> Asunto del Correo:
          </label>
          <input type="text" id="asunto-correo" placeholder="Ej: Informaci√≥n importante sobre la formaci√≥n" required
            style="font-size: 1em; padding: 12px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label for="mensaje-correo" style="display: block; font-weight: bold; margin-bottom: 8px;">
            <i class="fas fa-message"></i> Contenido del Mensaje:
          </label>
          <textarea id="mensaje-correo" placeholder="Escribe el mensaje que deseas enviar a los aprendices..." required
            rows="8" style="font-size: 0.95em; padding: 12px; font-family: Arial, sans-serif;"></textarea>
        </div>

        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn-verde" id="btn-enviar-correos"
            style="flex: 1; padding: 12px; font-size: 1.05em; font-weight: bold;">
            <i class="fas fa-paper-plane"></i> Enviar Correos
          </button>
          <button type="reset" style="flex: 1; padding: 12px; font-size: 1.05em; font-weight: bold;">
            <i class="fas fa-redo"></i> Limpiar
          </button>
        </div>
      </form>

      <div id="estado-envio" style="
                margin-top: 20px;
                padding: 15px;
                border-radius: 8px;
                display: none;
                text-align: center;
                font-weight: bold;
                font-size: 1.05em;
            "></div>
    </section>

    <section id="subir-programacion" class="section">
      <h2><i class="fas fa-upload"></i> Subir Programaci√≥n del Trimestre</h2>

      <form id="upload-form" enctype="multipart/form-data">
        <input type="file" id="file" name="file" accept=".xlsx,.xls,.csv" required>
        <button type="submit"
          style="padding: 10px; background: #006B2D; color: white; border: none; border-radius: 5px;">
          <i class="fas fa-upload"></i> Subir Archivo
        </button>
      </form>

      <div id="tabla-programacion" style="margin-top:20px;"></div>
    </section>

  </div>

  <div id="tooltip-dia" style="
  position: absolute;
  background: white;
  border: 1px solid #ccc;
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  font-size: 0.85em;
  display: none;
  z-index: 10000;
"></div>
  <div id="detalle-dia" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  border: 1px solid #006B2D;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  max-width: 300px;
  z-index: 10000;
  display: none;
">
    <button onclick="cerrarDetalleDia()" style="
    position: absolute;
    top: 5px; right: 5px;
    background: #ccc;
    border: none;
    border-radius: 50%;
    width: 25px; height: 25px;
    font-weight: bold;
    cursor: pointer;
  ">√ó</button>
    <div id="contenido-detalle-dia"></div>
  </div>

  <script th:inline="javascript">
let idInstructor = [[${idInstructor}]];
let nombreInstructor = '[[${usuario}]]';
let idUsuario = [[${idUsuario}]];
let ws = null;
let wsNotificaciones = null;
let fichaActual = null;
let currentSala = null;

// Funci√≥n para reproducir sonido de notificaci√≥n
function reproducirSonidoNotificacion() {
  try {
    const audio = new Audio('/sounds/notificacion.mp3');
    audio.volume = 0.7; // Volumen al 70%
    audio.play().catch(err => console.log('No se pudo reproducir sonido:', err));
  } catch (e) {
    console.error('Error reproduciendo sonido:', e);
  }
}

// Funci√≥n para mostrar notificaci√≥n visual
function mostrarNotificacionVisual(notificacion) {
  const titulo = notificacion.titulo || 'Nueva Notificaci√≥n';
  const mensaje = notificacion.mensaje || '';
  
  // Crear elemento de notificaci√≥n
  const notifDiv = document.createElement('div');
  notifDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #006B2D 0%, #008D4D 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    max-width: 350px;
    animation: slideIn 0.3s ease-out;
    font-family: 'Poppins', sans-serif;
    border-left: 4px solid #00FF99;
  `;
  
  notifDiv.innerHTML = `
    <strong>üîî ${titulo}</strong><br>
    <span style="font-size: 0.9em; margin-top: 5px; display: block;">${mensaje}</span>
  `;
  
  document.body.appendChild(notifDiv);
  
  // Auto-remover despu√©s de 5 segundos
  setTimeout(() => {
    notifDiv.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => notifDiv.remove(), 300);
  }, 5000);
}

// Agregar estilos de animaci√≥n
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// Conectar a WebSocket de notificaciones
function conectarWebSocketNotificaciones() {
  try {
    const wsProtocolo = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${wsProtocolo}://localhost:8080/notificaciones/instructor/${encodeURIComponent(idInstructor)}`;
    
    wsNotificaciones = new WebSocket(wsUrl);
    
    wsNotificaciones.onopen = () => {
      console.info('‚úÖ WebSocket de notificaciones conectado para instructor');
    };
    
    wsNotificaciones.onmessage = (evento) => {
      try {
        const notificacion = JSON.parse(evento.data);
        
        // Reproducir sonido si est√° habilitado
        if (notificacion.sonar !== false) {
          reproducirSonidoNotificacion();
        }
        
        // Mostrar notificaci√≥n visual
        mostrarNotificacionVisual(notificacion);
        
        console.log('üì¨ Notificaci√≥n recibida:', notificacion);
      } catch (e) {
        console.error('Error procesando notificaci√≥n:', e);
      }
    };
    
    wsNotificaciones.onerror = (error) => {
      console.error('‚ùå Error en WebSocket de notificaciones:', error);
    };
    
    wsNotificaciones.onclose = () => {
      console.info('‚ùå WebSocket de notificaciones cerrado');
      // Intentar reconectar despu√©s de 5 segundos
      setTimeout(conectarWebSocketNotificaciones, 5000);
    };
  } catch (e) {
    console.error('Error al conectar WebSocket de notificaciones:', e);
  }
}

document.addEventListener('DOMContentLoaded', function () {
  showSection('cronograma');

  if (idInstructor > 0) {
    cargarProgramacionInstructor(idInstructor);
    cargarInstructoresEnSelector();
    conectarWebSocketNotificaciones();
  }

  // Subida de archivo de programaci√≥n
  const uploadForm = document.getElementById('upload-form');
  if (uploadForm) {
    uploadForm.addEventListener('submit', subirArchivoProgramacion);
  }

  // Env√≠o de correos masivos
  const formCorreos = document.getElementById('formulario-correos');
  if (formCorreos) {
    formCorreos.addEventListener('submit', enviarCorreosMasivos);
  }

  const formChat = document.getElementById('form-chat');
  if (formChat) {
    formChat.addEventListener('submit', enviarMensajeChat);
  }
});

// -----------------------------
// FUNCIONES GENERALES
// -----------------------------
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  const sec = document.getElementById(sectionId);
  if (sec) sec.style.display = sectionId === 'mensajes' ? 'flex' : 'block';

  if (sectionId === 'mensajes') {
    cargarFichasChat(idInstructor);
  } else {
    if (ws) {
      ws.close();
      ws = null;
    }
  }

  if (sectionId === 'correos-masivos') {
    cargarAprendices();
  }
}

 // -----------------------------
    // PROGRAMACI√ìN INSTRUCTOR
    // -----------------------------
    function cargarProgramacionInstructor(id) {
      fetch('/programacion/instructor/' + id)
        .then(res => res.json())
        .then(data => mostrarTablaProgramacion(data, id === idInstructor));
    }

    function mostrarTablaProgramacion(data, esPropio = true) {
      const contenedor = document.getElementById('tabla-programacion');
      if (!contenedor) return;

      if (data.length === 0) {
        contenedor.innerHTML = `
        <p style="color: #666;">No hay programaci√≥n cargada.</p>
        <p><a href="#subir-programacion" onclick="showSection('subir-programacion')">Subir archivo</a></p>
      `;
        return;
      }

      const agrupado = {};
      data.forEach(p => {
        const clave = `${p.nombreFicha}|${p.curso}|${p.aula}|${p.horaInicio}|${p.horaFin}|${p.trimestre}`;
        if (!agrupado[clave]) {
          agrupado[clave] = { ...p, dias: [p.dia] };
        } else {
          agrupado[clave].dias.push(p.dia);
        }
      });

      let tabla = `
      <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
        <thead style="background: #006B2D; color: white;">
          <tr>
            <th>Ficha</th><th>Programa</th><th>Curso</th><th>Aula</th><th>Hora</th><th>Trimestre</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody>
    `;

      Object.values(agrupado).forEach(p => {
        let botonesAccion = `<button onclick="mostrarDias('${p.nombreFicha}', \`${p.curso}\`)">D√≠as</button>`;
        
        if (esPropio) {
          botonesAccion = `
            <button onclick="abrirChatFicha('${p.nombreFicha}')">Mensaje</button>
            <button onclick="mostrarDias('${p.nombreFicha}', \`${p.curso}\`)">D√≠as</button>
          `;
        }
        
        tabla += `
        <tr style="border-bottom: 1px solid #ccc;">
          <td>${p.nombreFicha}</td>
          <td>${p.programa || ''}</td>
          <td>${p.curso}</td>
          <td>${p.aula}</td>
          <td>${p.horaInicio} - ${p.horaFin}</td>
          <td>${p.trimestre}</td>
          <td>${botonesAccion}</td>
        </tr>
      `;
      });

      tabla += '</tbody></table>';
      contenedor.innerHTML = tabla;
    }

    function mostrarDias(ficha, curso) {
      fetch('/programacion/instructor/' + idInstructor)
        .then(res => res.json())
        .then(data => {
          const coincidencias = data.filter(p =>
            p.nombreFicha.trim().toUpperCase() === ficha.trim().toUpperCase() &&
            p.curso.trim().toUpperCase() === curso.trim().toUpperCase()
          );

          const diasProgramados = coincidencias.map(p => normalizarDia(p.dia));
          const instructor = coincidencias[0]?.nombreInstructor || 'Instructor asignado';
          const meses = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
          const nombreDias = ["LUNES", "MARTES", "MI√âRCOLES", "JUEVES", "VIERNES", "S√ÅBADO", "DOMINGO"];
          const mapaMeses = {
            "ENERO": 0, "FEBRERO": 1, "MARZO": 2, "ABRIL": 3,
            "MAYO": 4, "JUNIO": 5, "JULIO": 6, "AGOSTO": 7,
            "SEPTIEMBRE": 8, "OCTUBRE": 9, "NOVIEMBRE": 10, "DICIEMBRE": 11
          };

          function generarCalendarioMes(mesTexto) {
            const mes = mapaMeses[mesTexto];
            const a√±o = new Date().getFullYear();
            const fechaInicio = new Date(a√±o, mes, 1);
            const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
            const primerDiaSemana = (fechaInicio.getDay() + 6) % 7;

            let html = `<h3 style="text-align:center; margin-top:20px;">${mesTexto} ${a√±o}</h3>`;
            html += `<table style="border-collapse:collapse; width:100%; font-size:0.85em;">
                  <thead><tr>${nombreDias.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody><tr>`;

            let diaActual = 1;
            let diaSemana = primerDiaSemana;

            for (let i = 0; i < diaSemana; i++) {
              html += `<td></td>`;
            }

            while (diaActual <= diasEnMes) {
              const clave = normalizarDia(`${diaActual} ${mesTexto}`);
              const marcado = diasProgramados.includes(clave);
              html += `<td style="text-align:center; padding:6px; background:${marcado ? '#e6f4ea' : 'transparent'};">
                    ${diaActual}<br>${marcado ? '‚úî' : ''}
                   </td>`;
              diaActual++;
              diaSemana++;
              if (diaSemana === 7 && diaActual <= diasEnMes) {
                html += `</tr><tr>`;
                diaSemana = 0;
              }
            }

            for (let i = diaSemana; i < 7; i++) {
              html += `<td></td>`;
            }

            html += `</tr></tbody></table>`;
            return html;
          }

          document.getElementById('info-ficha-curso').innerHTML = `
        <p><strong>Ficha:</strong> ${ficha}</p>
        <p><strong>Curso:</strong> ${curso}</p>
        <p><strong>Instructor:</strong> ${instructor}</p>
      `;

          const htmlCalendarios = meses.map(m => generarCalendarioMes(m)).join('<hr>');
          document.getElementById('calendario-trimestre').innerHTML = htmlCalendarios;
          const modal = document.getElementById('modal-dias');
          modal.style.display = 'flex';
          modal.style.justifyContent = 'center';
          modal.style.alignItems = 'center';
        });
    }

    function normalizarDia(diaTexto) {
      return diaTexto
        .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
        .trim()
        .toUpperCase()
        .replace(/\s+/g, ' ');
    }

    function cerrarModalDias() {
      document.getElementById('modal-dias').style.display = 'none';
    }

    function imprimirCalendario() {
      const contenido = document.getElementById('contenido-modal-dias').innerHTML;
      const ventana = window.open('', '', 'width=900,height=700');
      ventana.document.write(`
    <html>
      <head>
        <title>Calendario Trimestral</title>
        <style>
          body { font-family: sans-serif; padding: 20px; }
          table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
          th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
          th { background: #f0f0f0; }
        </style>
      </head>
      <body>${contenido}</body>
    </html>
  `);
      ventana.document.close();
      ventana.print();
    }

    function abrirCalendarioGeneral() {
      Promise.all([
        fetch('/programacion/instructor/' + idInstructor).then(res => res.json()),
        fetch('/api/externos/festivos').then(res => res.json())
      ]).then(([programacion, responseFestivos]) => {

        window.sesionesPorDia = {};
        programacion.forEach(p => {
          const clave = normalizarDia(p.dia);
          if (!sesionesPorDia[clave]) sesionesPorDia[clave] = [];
          sesionesPorDia[clave].push(p);
        });

        // Procesar Festivos
        // La API devuelve: { datos: [ {date: '2025-01-01', localName: 'A√±o Nuevo'} ... ] }
        const listaFestivos = responseFestivos.datos || [];
        const mapaFestivos = {};
        listaFestivos.forEach(f => {
          // Guardamos por fecha YYYY-MM-DD
          mapaFestivos[f.date] = f.localName;
        });

        const meses = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
        const nombreDias = ["LUNES", "MARTES", "MI√âRCOLES", "JUEVES", "VIERNES", "S√ÅBADO", "DOMINGO"];
        const mapaMeses = {
          "ENERO": 0, "FEBRERO": 1, "MARZO": 2, "ABRIL": 3,
          "MAYO": 4, "JUNIO": 5, "JULIO": 6, "AGOSTO": 7,
          "SEPTIEMBRE": 8, "OCTUBRE": 9, "NOVIEMBRE": 10, "DICIEMBRE": 11
        };

        // Mapeo de trimestres a sus meses (configuraci√≥n SENA)
        const trimestresAMeses = {
          "1": ["ENERO", "FEBRERO", "MARZO"],
          "2": ["ABRIL", "MAYO", "JUNIO"],
          "3": ["JULIO", "AGOSTO", "SEPTIEMBRE"],
          "4": ["OCTUBRE", "NOVIEMBRE", "DICIEMBRE"],
          "5": ["ENERO", "FEBRERO", "MARZO"],
          "6": ["ABRIL", "MAYO", "JUNIO"],
          "7": ["JULIO", "AGOSTO", "SEPTIEMBRE"],
          "8": ["OCTUBRE", "NOVIEMBRE", "DICIEMBRE"]
        };

        // Mapeo inverso: mes -> trimestres v√°lidos
        const mesTrimestre = {
          "ENERO": ["1", "5"], "FEBRERO": ["1", "5"], "MARZO": ["1", "5"],
          "ABRIL": ["2", "6"], "MAYO": ["2", "6"], "JUNIO": ["2", "6"],
          "JULIO": ["3", "7"], "AGOSTO": ["3", "7"], "SEPTIEMBRE": ["3", "7"],
          "OCTUBRE": ["4", "8"], "NOVIEMBRE": ["4", "8"], "DICIEMBRE": ["4", "8"]
        };

        // Extraer trimestres √∫nicos y ordenarlos
        const trimestresUnicos = new Set();
        const mesesPorTrimestre = {}; // Mapa de trimestre -> meses con datos
        
        programacion.forEach(p => {
          // Extraer mes del campo dia (formato: "3 FEBRERO")
          const partes = p.dia.trim().split(/\s+/);
          const mesTexto = partes[partes.length - 1].toUpperCase();
          
          // Deducir trimestre correcto basado en el mes
          let trimestre = p.trimestre?.toString() || "1";
          const trimestresValidos = mesTrimestre[mesTexto] || ["1"];
          
          // Si el trimestre asignado no es v√°lido para este mes, usar el primero v√°lido
          if (!trimestresValidos.includes(trimestre)) {
            trimestre = trimestresValidos[0];
          }
          
          trimestresUnicos.add(trimestre);
          
          if (!mesesPorTrimestre[trimestre]) {
            mesesPorTrimestre[trimestre] = new Set();
          }
          mesesPorTrimestre[trimestre].add(mesTexto);
        });

        const trimestresOrdenados = Array.from(trimestresUnicos).sort((a, b) => Number(a) - Number(b));

        function generarMes(mesTexto) {
          const mes = mapaMeses[mesTexto];
          const a√±o = new Date().getFullYear();
          const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
          const primerDiaSemana = (new Date(a√±o, mes, 1).getDay() + 6) % 7;

          let html = `<h3 style="text-align:center; margin-top:20px; color:#006B2D;">${mesTexto} ${a√±o}</h3>`;
          html += `<table style="border-collapse:collapse; width:100%; font-size:0.9em; background:white; border:1px solid #ccc;">
                  <thead style="background:#f0f0f0;">
                    <tr>${nombreDias.map(d => `<th style="padding:8px; border:1px solid #ccc;">${d}</th>`).join('')}</tr>
                  </thead>
                  <tbody><tr>`;

          let diaActual = 1;
          let diaSemana = primerDiaSemana;

          for (let i = 0; i < diaSemana; i++) html += `<td style="border:1px solid #ccc; padding:10px;"></td>`;

          while (diaActual <= diasEnMes) {
            // Clave para programaci√≥n (D√çA MES)
            const clave = normalizarDia(`${diaActual} ${mesTexto}`);
            const sesiones = window.sesionesPorDia?.[clave] || [];

            // Clave para festivos (YYYY-MM-DD)
            // Ojo: los meses en JS son 0-indexados, necesitamos 01, 02... 12
            const mesNum = (mes + 1).toString().padStart(2, '0');
            const diaNum = diaActual.toString().padStart(2, '0');
            const fechaIso = `${a√±o}-${mesNum}-${diaNum}`;

            const nombreFestivo = mapaFestivos[fechaIso];

            // Definir estilos
            let background = 'white';
            let contenido = `<strong>${diaActual}</strong><br>`;
            let cursor = 'default';
            let acciones = '';

            if (nombreFestivo) {
              // Es festivo
              background = '#fff0f0'; // Rojo suave
              contenido += `<span style="color:#d63031; font-size:0.8em;">üéâ ${nombreFestivo}</span>`;
            } else if (sesiones.length > 0) {
              // Hay clase
              background = '#e6f4ea'; // Verde suave
              contenido += `<span style="color:green;">‚úîÔ∏è</span>`;
              cursor = 'pointer';
              acciones = `onclick="mostrarDetalleDia('${clave}')"`;
            }

            html += `<td style="
            border: 1px solid #ccc;
            padding: 10px;
            background: ${background};
            cursor: ${cursor};
            text-align: center;
            vertical-align: top;
            height: 60px;
          " ${acciones}>
            ${contenido}
          </td>`;

            diaActual++;
            diaSemana++;
            if (diaSemana === 7 && diaActual <= diasEnMes) {
              html += `</tr><tr>`;
              diaSemana = 0;
            }
          }

          for (let i = diaSemana; i < 7; i++) html += `<td style="border:1px solid #ccc; padding:10px;"></td>`;
          html += `</tr></tbody></table>`;
          return html;
        }

        // Generar HTML agrupado por trimestres
        const htmlPorTrimestre = trimestresOrdenados.map(trimestre => {
          // Obtener TODO los meses que realmente existen para este trimestre (sin limitar a nominales)
          const mesesReales = Array.from(mesesPorTrimestre[trimestre] || []).sort((a, b) => {
            return (mapaMeses[a] || 0) - (mapaMeses[b] || 0);
          });
          
          if (mesesReales.length === 0) return ''; // No mostrar trimestres sin meses
          
          const htmlMeses = mesesReales.map(m => generarMes(m)).join('<hr style="margin: 20px 0;">');
          return `
            <div style="margin-bottom: 40px; padding: 20px; background: #f9f9f9; border-left: 4px solid #006B2D;">
              <h2 style="color: #006B2D; margin-top: 0;">Trimestre ${trimestre}</h2>
              ${htmlMeses}
            </div>
          `;
        }).join('');

        document.getElementById('contenido-calendario-general').innerHTML = htmlPorTrimestre;
        document.getElementById('modal-calendario-general').style.display = 'block';
      })
        .catch(err => {
          console.error("Error cargando calendario:", err);
          alert("Error cargando datos del calendario.");
        });
    }

    function cerrarCalendarioGeneral() {
      document.getElementById('modal-calendario-general').style.display = 'none';
      // Cerrar el panel flotante de detalle
      document.getElementById('detalle-dia').style.display = 'none';

    }

    function exportarCalendarioGeneral() {
      const contenido = document.getElementById('contenido-calendario-general').innerHTML;
      const ventana = window.open('', '', 'width=900,height=700');
      ventana.document.write(`
    <html>
      <head>
        <title>Calendario Trimestral</title>
        <style>
          body { font-family: sans-serif; padding: 20px; }
          table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
          th, td { border: 1px solid #ccc; padding: 6px; text-align: center; vertical-align: top; }
          th { background: #f0f0f0; }
        </style>
      </head>
      <body>${contenido}</body>
    </html>
  `);
      ventana.document.close();
      ventana.print();
    }

    function normalizarDia(diaTexto) {
      return diaTexto
        .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
        .trim()
        .toUpperCase()
        .replace(/\s+/g, ' ');
    }

    function mostrarTooltipDia(clave) {
      const sesiones = sesionesPorDia[clave];
      if (!sesiones || sesiones.length === 0) return;

      const tooltip = document.getElementById('tooltip-dia');
      tooltip.innerHTML = sesiones.map(s => `
    <div style="margin-bottom:6px;">
      <strong>${s.nombreFicha}</strong><br>
      ${s.curso}<br>
      ${s.horaInicio} - ${s.horaFin}<br>
      Aula ${s.aula}
    </div>
  `).join('');

      document.onmousemove = function (e) {
        tooltip.style.left = (e.pageX + 15) + 'px';
        tooltip.style.top = (e.pageY + 15) + 'px';
        tooltip.style.display = 'block';
      };
    }

    document.addEventListener('mouseleave', () => {
      document.getElementById('tooltip-dia').style.display = 'none';
    });

    function mostrarDetalleDia(clave) {
      const sesiones = window.sesionesPorDia[clave];
      if (!sesiones || sesiones.length === 0) return;

      // Eliminar duplicados
      const sesionesUnicas = [];
      const vistos = new Set();

      sesiones.forEach(s => {
        const claveUnica = `${s.nombreFicha}|${s.curso}|${s.horaInicio}|${s.horaFin}|${s.aula}`;
        if (!vistos.has(claveUnica)) {
          vistos.add(claveUnica);
          sesionesUnicas.push(s);
        }
      });

      const contenedor = document.getElementById('contenido-detalle-dia');
      contenedor.innerHTML = sesionesUnicas.map(s => `
    <div style="margin-bottom:10px; border-bottom:1px solid #ccc; padding-bottom:6px;">
      <strong>Ficha:</strong> ${s.nombreFicha}<br>
      <strong>Curso:</strong> ${s.curso}<br>
      <strong>Hora:</strong> ${s.horaInicio} - ${s.horaFin}<br>
      <strong>Ambiente:</strong> ${s.aula}<br>
      <button onclick="abrirChatFicha('${s.nombreFicha}')" style="
        margin-top: 6px;
        background: #006B2D;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      ">üí¨ Ir a mensajes</button>
    </div>
  `).join('');

      document.getElementById('detalle-dia').style.display = 'block';
    }

    function cerrarDetalleDia() {
      document.getElementById('detalle-dia').style.display = 'none';
    }



// -----------------------------
// CHAT GRUPAL
// -----------------------------
function cargarFichasChat(id) {
  fetch(`/programacion/fichas/${id}`)
    .then(res => res.json())
    .then(fichas => {
      const ul = document.getElementById('fichas-chat');
      ul.innerHTML = '';

      if (!fichas || fichas.length === 0) {
        ul.innerHTML = '<li>No tienes fichas asignadas</li>';
        return;
      }

      fichas.forEach(f => {
        const fichaOriginal = f.trim(); // ‚úÖ Mostrar la ficha completa
        const fichaBase = f
          .replace("‚Äì", "-")
          .split("-")
          .pop()        // ‚úÖ Tomar la √öLTIMA ficha (la base real)
          .trim();

        const li = document.createElement('li');
        li.innerHTML = `
          <button onclick="abrirChatFicha('${fichaBase}', '${fichaOriginal}')">
            üí¨ Ficha ${fichaOriginal}
          </button>`;
        ul.appendChild(li);
      });
    })
    .catch(err => console.error('Error cargando fichas', err));
}

function abrirChatFicha(fichaBase, fichaOriginal) {

  // Use the full fichaOriginal when connecting so the handler registers all real fichas
  fichaActual = fichaOriginal;
  const sala = fichaOriginal + "|" + idInstructor;

  document.getElementById('titulo-chat').innerText = `Ficha ${fichaOriginal}`;
  document.getElementById('mensajes-grupo').innerHTML = '';

  if (ws) ws.close();

  currentSala = sala;
  // Open WS using path segments and encode the fichaOriginal (may contain ranges)
  const pathFicha = encodeURIComponent(fichaOriginal);
  const pathInstructor = encodeURIComponent(idInstructor);
  ws = new WebSocket(`ws://localhost:8080/chat/${pathFicha}/${pathInstructor}`);

  ws.onopen = () => {
    console.info('WebSocket conectado a', sala);
  };

  ws.onmessage = e => mostrarMensaje(JSON.parse(e.data));

  ws.onerror = err => {
    console.error('WebSocket error', err);
    const estado = document.getElementById('estado-envio');
    if (estado) { estado.style.display = 'block'; estado.style.background = '#f8d7da'; estado.style.color = '#721c24'; estado.textContent = 'Error en la conexi√≥n de chat.'; }
  };

  ws.onclose = () => {
    console.info('WebSocket cerrado:', sala);
  };

  // Cargar mensajes: Search using the FULL fichaOriginal (may be a range)
  fetch(`/mensajes/ficha/${encodeURIComponent(fichaOriginal)}/${idInstructor}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      data.sort((a,b) => new Date(a.fechaEnvio) - new Date(b.fechaEnvio));
      data.forEach(mostrarMensaje);
    })
    .catch(err => console.error('Error cargando mensajes:', err));
}

async function enviarMensajeChat(e) {
  e.preventDefault();

  const texto = document.getElementById('mensaje').value.trim();
  if (!texto) return;

  if (!fichaActual) {
    alert('Selecciona una ficha primero');
    return;
  }

  const sala = fichaActual + "|" + idInstructor;

  // Si no hay conexi√≥n, intentar reconectar
  try {
    await ensureWebSocketConnected(sala);
  } catch (err) {
    alert('No se pudo conectar al chat. Intenta de nuevo.');
    return;
  }

  ws.send(JSON.stringify({
    ficha: fichaActual,
    sala: sala,
    mensaje: texto,
    idEmisor: idUsuario,
    nombreEmisor: nombreInstructor,
    rolEmisor: 'Instructor'
  }));

  document.getElementById('mensaje').value = '';
}

function uploadFileInstructor() {
  const input = document.getElementById('archivo-mensaje');
  if (!input?.files?.length) return;
  const file = input.files[0];
  const fd = new FormData();
  fd.append('file', file);

  fetch('/mensajes/upload', { method: 'POST', body: fd })
    .then(res => res.json())
    .then(data => {
      if (data?.success) {
        const m = {
          idEmisor: idUsuario,
          nombreEmisor: nombreInstructor,
          rolEmisor: 'Instructor',
          fileUrl: data.url,
          fileName: file.name,
          mensaje: ''
        };
        mostrarMensaje(m);
        
        if (ws?.readyState === 1) {
          ws.send(JSON.stringify({
            ficha: fichaActual,
            sala: window.currentSala,
            idEmisor: idUsuario,
            nombreEmisor: nombreInstructor,
            rolEmisor: 'Instructor',
            fileUrl: data.url,
            fileName: file.name,
            mensaje: ''
          }));
        }
        
        input.value = '';
      } else {
        alert('Error: ' + (data?.error || 'No se pudo subir el archivo'));
      }
    })
    .catch(err => {
      console.error('Error subiendo archivo:', err);
      alert('Error de conexi√≥n');
    });
}

function ensureWebSocketConnected(sala) {
  return new Promise((resolve, reject) => {
    if (ws && ws.readyState === WebSocket.OPEN && currentSala === sala) return resolve();

    // Si ws existe pero diferente sala, cerrarla
    if (ws && currentSala !== sala) {
      try { ws.close(); } catch (e) { }
      ws = null;
    }

    // Crear nueva conexi√≥n y esperar onopen
    if (!ws) {
      currentSala = sala;
      const parts = sala.split('|');
      const pathFicha = encodeURIComponent(parts[0]);
      const pathInstructor = encodeURIComponent(parts[1] || '');
      ws = new WebSocket(`ws://localhost:8080/chat/${pathFicha}/${pathInstructor}`);

      const timeout = setTimeout(() => {
        ws.onerror = ws.onopen = ws.onclose = null;
        reject(new Error('timeout'));
      }, 5000);

      ws.onopen = () => {
        clearTimeout(timeout);
        resolve();
      };

      ws.onerror = (err) => {
        clearTimeout(timeout);
        reject(err);
      };
    } else {
      // ya existe pero no abierta
      const checkInterval = setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
          clearInterval(checkInterval);
          resolve();
        } else if (ws.readyState === WebSocket.CLOSED) {
          clearInterval(checkInterval);
          reject(new Error('closed'));
        }
      }, 200);
    }
  });
}

function mostrarMensaje(m) {
  const cont = document.getElementById('mensajes-grupo');
  if (!cont) return;

  // Crear fila contenedora para controlar alineaci√≥n
  const row = document.createElement('div');
  row.className = 'message-row';

  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble';

  // Sanitizar nombre: quitar comillas y codificaciones comunes
  const rawName = (m && m.nombreEmisor) ? String(m.nombreEmisor) : '';
  const nombre = rawName.replace(/%22/g, '').replace(/\"/g, '').replace(/"/g, '').replace(/'/g, '').trim();

  // Escape b√°sico del mensaje para evitar HTML no deseado
  const rawMsg = (m && m.mensaje) ? String(m.mensaje) : '';
  const escapeHtml = s => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  const mensajeEsc = escapeHtml(rawMsg);

  // Determinar emoji por rol
  let emoji = 'üë§';
  if (m && m.rolEmisor && String(m.rolEmisor).toLowerCase().includes('instructor')) {
    emoji = 'üë®‚Äçüè´';
  } else if (m && m.rolEmisor && String(m.rolEmisor).toLowerCase().includes('aprendiz')) {
    emoji = 'üë®‚Äçüéì';
  }

  bubble.innerHTML = `<strong>${emoji} ${nombre || ''}</strong><br>`;
  const contentDiv = document.createElement('div');
  contentDiv.style.marginTop = '6px';

  if (m && m.fileUrl) {
    // Mostrar archivo como burbuja tipo WhatsApp
    const fileLink = document.createElement('a');
    fileLink.href = m.fileUrl;
    fileLink.target = '_blank';
    fileLink.style.display = 'flex';
    fileLink.style.alignItems = 'center';
    fileLink.style.gap = '8px';
    fileLink.style.padding = '8px 0';
    fileLink.style.color = '#fff';
    fileLink.style.textDecoration = 'none';
    fileLink.style.cursor = 'pointer';

    // Icono seg√∫n tipo de archivo
    const fileIcon = document.createElement('span');
    const fileName = (m.fileName || '').toLowerCase();
    if (fileName.includes('.pdf')) {
      fileIcon.textContent = 'üìÑ';
    } else if (fileName.match(/\.(jpg|jpeg|png|gif)$/)) {
      fileIcon.textContent = 'üñºÔ∏è';
    } else if (fileName.match(/\.(doc|docx)$/)) {
      fileIcon.textContent = 'üìù';
    } else if (fileName.match(/\.(zip|rar|7z)$/)) {
      fileIcon.textContent = 'üì¶';
    } else {
      fileIcon.textContent = 'üìé';
    }
    fileIcon.style.fontSize = '20px';

    const fileNameSpan = document.createElement('span');
    fileNameSpan.textContent = m.fileName || 'Descargar archivo';
    fileNameSpan.style.whiteSpace = 'nowrap';
    fileNameSpan.style.overflow = 'hidden';
    fileNameSpan.style.textOverflow = 'ellipsis';
    fileNameSpan.style.maxWidth = '150px';

    fileLink.appendChild(fileIcon);
    fileLink.appendChild(fileNameSpan);
    contentDiv.appendChild(fileLink);

    if (m.mensaje) {
      const span = document.createElement('div');
      span.style.marginTop = '6px';
      span.textContent = mensajeEsc;
      contentDiv.appendChild(span);
    }
  } else {
    contentDiv.textContent = mensajeEsc;
  }
  bubble.appendChild(contentDiv);

  // Determinar tipo: propio (instructor), aprendiz, u otros
  // Comparar con `idUsuario` (id del usuario logeado) y normalizar a string
  const isOwn = (m && (m.idEmisor !== undefined ? String(m.idEmisor) === String(idUsuario) : false));
  if (isOwn) {
    // Mensaje del instructor logeado
    row.classList.add('own');
    bubble.classList.add('own');
  } else if (m && m.rolEmisor && String(m.rolEmisor).toLowerCase().includes('aprendiz')) {
    // Mensaje de aprendiz
    row.classList.add('left');
    bubble.classList.add('aprendiz');
  } else {
    // Mensaje de otro instructor
    row.classList.add('left');
    bubble.classList.add('other');
  }

  row.appendChild(bubble);
  cont.appendChild(row);

  // Auto-scroll al √∫ltimo mensaje
  cont.scrollTop = cont.scrollHeight;
}
function conectarWebSocket() {
  // Solo se activa dentro de showSection('mensajes')
}

// -----------------------------
// ENV√çO DE CORREOS MASIVOS
// -----------------------------
function cargarAprendices() {
  fetch('/api/email/aprendices')
    .then(res => res.json())
    .then(data => {
      if (data.exito) {
        aprendicesDisponibles = data.aprendices || [];
        mostrarAprendices();
      } else {
        document.getElementById('lista-aprendices').innerHTML =
          '<p style="color: #d63912;">Error al cargar aprendices: ' + data.mensaje + '</p>';
      }
    })
    .catch(err => {
      console.error('Error:', err);
      document.getElementById('lista-aprendices').innerHTML =
        '<p style="color: #d63912;">Error de conexi√≥n al cargar aprendices</p>';
    });
}

function mostrarAprendices() {
  // ... (sin cambios)
}

function enviarCorreosMasivos(e) {
  e.preventDefault();
  // ... (sin cambios)
}

// -----------------------------
// SUBIDA DE ARCHIVO
// -----------------------------
function subirArchivoProgramacion(e) {
  e.preventDefault();
  const fileInput = document.getElementById('file');
  const estado = document.getElementById('estado-envio');
  if (!fileInput || fileInput.files.length === 0) {
    alert('Selecciona un archivo a subir');
    return;
  }

  const archivo = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', archivo);

  // Mostrar estado
  estado.style.display = 'block';
  estado.style.background = '#fff3cd';
  estado.style.color = '#856404';
  estado.textContent = 'Subiendo archivo...';

  fetch('/programacion/upload', {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'
  })
    .then(res => res.json())
    .then(json => {
      if (json.error) {
        estado.style.background = '#f8d7da';
        estado.style.color = '#721c24';
        estado.textContent = 'Error: ' + (json.error || 'Error al procesar el archivo');
        console.error('Upload error:', json);
        return;
      }

      estado.style.background = '#d4edda';
      estado.style.color = '#155724';
      estado.textContent = json.mensaje || 'Archivo subido correctamente';

      // Si el servidor devuelve la programaci√≥n procesada, actualizar la vista
      if (Array.isArray(json.programacion)) {
        mostrarTablaProgramacion(json.programacion);
      }
    })
    .catch(err => {
      console.error('Error subiendo archivo:', err);
      estado.style.background = '#f8d7da';
      estado.style.color = '#721c24';
      estado.textContent = 'Error subiendo archivo';
    })
    .finally(() => setTimeout(() => { estado.style.display = 'none'; }, 5000));
}

// -----------------------------
// UTILIDADES
// -----------------------------
function descargarCertificado(tipo) {
  window.location.href = `/certificados/${tipo}/${idUsuario}`;
}

// Funci√≥n para cargar todos los instructores en el selector
function cargarInstructoresEnSelector() {
  fetch('/programacion/todos-instructores')
    .then(res => res.json())
    .then(instructores => {
      const selector = document.getElementById('selector-instructor');
      if (!selector) return;

      instructores.forEach(inst => {
        if (inst.programacion && inst.programacion.length > 0) {
          const option = document.createElement('option');
          option.value = inst.id;
          option.textContent = inst.nombre;
          selector.appendChild(option);
        }
      });

      // Manejar cambio de selector
      selector.addEventListener('change', function() {
        if (this.value === '') {
          cargarProgramacionInstructor(idInstructor);
        } else {
          cargarProgramacionInstructor(this.value);
        }
      });
    })
    .catch(err => console.error('Error cargando instructores:', err));
}

// Funci√≥n para eliminar una programaci√≥n
function eliminarProgramacion(idProgramacion) {
  if (!confirm('¬øEst√°s seguro de que quieres eliminar esta programaci√≥n?')) {
    return;
  }

  fetch(`/programacion/${idProgramacion}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.mensaje) {
        alert('Programaci√≥n eliminada correctamente');
        cargarProgramacionInstructor(idInstructor);
      } else if (data.error) {
        alert('Error: ' + data.error);
      }
    })
    .catch(err => {
      console.error('Error eliminando programaci√≥n:', err);
      alert('Error al eliminar la programaci√≥n');
    });
}
</script>


</body>

</html>